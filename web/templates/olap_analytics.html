{% extends "base.html" %}

{% block title %}Análisis de Datos - SugarBI{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #2c5530;
        --secondary-color: #4a7c59;
        --accent-color: #6fa8dc;
        --background-color: #f8f9fa;
        --card-background: #ffffff;
        --text-color: #2c3e50;
        --border-color: #e9ecef;
        --success-color: #28a745;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #17a2b8;
    }

    body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .analytics-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .header-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header-section h1 {
        margin: 0;
        font-size: 2rem;
        font-weight: 600;
    }

    .header-section p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }

    .main-layout {
        display: grid;
        grid-template-columns: 250px 1fr 250px;
        grid-template-rows: 1fr auto;
        gap: 20px;
        height: calc(100vh - 200px);
    }

    .panel {
        background: var(--card-background);
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-color);
        overflow: hidden;
    }

    .panel-header {
        background: var(--primary-color);
        color: white;
        padding: 15px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .panel-content {
        padding: 15px;
        height: calc(100% - 60px);
        overflow-y: auto;
    }

    .toolbox {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .tool-section {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .tool-section-header {
        background: var(--accent-color);
        color: white;
        padding: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tool-section-content {
        padding: 10px;
        background: white;
    }

    .tool-item {
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 8px 12px;
        margin: 5px 0;
        cursor: grab;
        transition: all 0.2s ease;
        font-size: 0.9rem;
    }

    .tool-item:hover {
        background: var(--accent-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .tool-item:active {
        cursor: grabbing;
    }

    .drop-zone {
        border: 2px dashed var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        min-height: 60px;
        background: #fafafa;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .drop-zone.drag-over {
        border-color: var(--accent-color);
        background: rgba(111, 168, 220, 0.1);
    }

    .drop-zone.empty {
        color: #6c757d;
        font-style: italic;
    }

    .drop-zone.has-items {
        border-style: solid;
        border-color: var(--success-color);
        background: rgba(40, 167, 69, 0.05);
    }

    .dropped-item {
        background: var(--success-color);
        color: white;
        padding: 6px 10px;
        border-radius: 4px;
        margin: 3px;
        display: inline-block;
        font-size: 0.8rem;
        position: relative;
    }

    .dropped-item .remove-btn {
        background: none;
        border: none;
        color: white;
        margin-left: 8px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .data-panel {
        display: flex;
        flex-direction: column;
    }

    .data-controls {
        background: var(--card-background);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .charts-section {
        margin-bottom: 20px;
    }

    .data-table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }

    .stats-mini {
        display: flex;
        gap: 15px;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .dynamic-filter-section {
        background: var(--card-background);
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--border-color);
    }

    .dynamic-filter-header {
        background: var(--info-color);
        color: white;
        padding: 10px;
        font-weight: 600;
        border-radius: 8px 8px 0 0;
        font-size: 0.9rem;
    }

    .dynamic-filter-content {
        padding: 15px;
    }

    .filter-options {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 10px;
        background: #fafafa;
    }

    .filter-option {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 5px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .filter-option:hover {
        background: rgba(111, 168, 220, 0.1);
    }

    .filter-option input[type="checkbox"] {
        margin-right: 8px;
    }

    .filter-option label {
        margin: 0;
        cursor: pointer;
        font-size: 0.9rem;
    }

    .select-all-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-bottom: 10px;
    }

    .select-all-btn:hover {
        background: #5a9bd4;
    }

    .control-row {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .control-row:last-child {
        margin-bottom: 0;
    }

    .btn-primary {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background: var(--secondary-color);
        border-color: var(--secondary-color);
    }

    .btn-secondary {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: white;
    }

    .btn-secondary:hover {
        background: #5a9bd4;
        border-color: #5a9bd4;
    }

    .data-table-container {
        flex: 1;
        background: var(--card-background);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: var(--primary-color);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table tbody tr:hover {
        background: rgba(111, 168, 220, 0.1);
    }

    .filters-panel {
        display: flex;
        flex-direction: column;
    }

    .filter-section {
        background: var(--card-background);
        border-radius: 10px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .filter-section-header {
        background: var(--info-color);
        color: white;
        padding: 12px;
        font-weight: 600;
        border-radius: 10px 10px 0 0;
    }

    .filter-section-content {
        padding: 15px;
    }

    .filter-item {
        margin-bottom: 10px;
    }

    .filter-item:last-child {
        margin-bottom: 0;
    }

    .filter-item label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--text-color);
    }

    .filter-item select,
    .filter-item input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 15px;
    }

    .stat-item {
        background: var(--card-background);
        padding: 10px;
        border-radius: 6px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
    }

    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 2px;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #dee2e6;
    }

    .chart-container {
        background: var(--card-background);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chart-container h5 {
        margin-bottom: 15px;
        color: var(--primary-color);
        font-weight: 600;
    }

    .collapsible {
        cursor: pointer;
    }

    .collapsible::after {
        content: '▼';
        transition: transform 0.3s ease;
    }

    .collapsible.collapsed::after {
        transform: rotate(-90deg);
    }

    .collapsible-content {
        max-height: 200px;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .collapsible-content.collapsed {
        max-height: 0;
    }

    @media (max-width: 1200px) {
        .main-layout {
            grid-template-columns: 250px 1fr 250px;
        }
    }

    @media (max-width: 992px) {
        .main-layout {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Header -->
    <div class="header-section">
        <h1><i class="fas fa-chart-line"></i> Análisis de Datos</h1>
        <p>Tablas dinámicas y análisis multidimensional interactivo</p>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Panel - Toolbox -->
        <div class="panel toolbox">
            <div class="panel-header">
                <i class="fas fa-tools"></i> Herramientas
            </div>
            <div class="panel-content">
                <!-- Analysis Controls -->
                <div class="data-controls">
                    <div class="control-row">
                        <div class="drop-zone empty" id="dimensions-zone">
                            <span>Arrastra dimensiones aquí</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <div class="drop-zone empty" id="measures-zone">
                            <span>Arrastra medidas aquí</span>
                        </div>
                    </div>
                    
                    <div class="control-row">
                        <button class="btn btn-primary" id="execute-btn">
                            <i class="fas fa-play"></i> Ejecutar Análisis
                        </button>
                    </div>
                    
                    <div class="control-row">
                        <button class="btn btn-secondary" id="export-btn">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                    </div>
                </div>
                <!-- Dimensiones -->
                <div class="tool-section">
                    <div class="tool-section-header collapsible" onclick="toggleSection(this)">
                        <span><i class="fas fa-layer-group"></i> Dimensiones</span>
                    </div>
                    <div class="tool-section-content collapsible-content">
                        <div class="tool-item" draggable="true" data-type="dimension" data-dimension="tiempo" data-level="year">
                            <i class="fas fa-calendar"></i> Tiempo (Año)
                        </div>
                        <div class="tool-item" draggable="true" data-type="dimension" data-dimension="tiempo" data-level="month">
                            <i class="fas fa-calendar-alt"></i> Tiempo (Mes)
                        </div>
                        <div class="tool-item" draggable="true" data-type="dimension" data-dimension="geografia" data-level="zone">
                            <i class="fas fa-map-marker-alt"></i> Zona
                        </div>
                        <div class="tool-item" draggable="true" data-type="dimension" data-dimension="geografia" data-level="farm">
                            <i class="fas fa-home"></i> Finca
                        </div>
                        <div class="tool-item" draggable="true" data-type="dimension" data-dimension="producto" data-level="variety">
                            <i class="fas fa-seedling"></i> Variedad
                        </div>
                    </div>
                </div>

                <!-- Medidas -->
                <div class="tool-section">
                    <div class="tool-section-header collapsible" onclick="toggleSection(this)">
                        <span><i class="fas fa-chart-bar"></i> Medidas</span>
                    </div>
                    <div class="tool-section-content collapsible-content">
                        <div class="tool-item" draggable="true" data-type="measure" data-measure="toneladas">
                            <i class="fas fa-weight"></i> Toneladas
                        </div>
                        <div class="tool-item" draggable="true" data-type="measure" data-measure="tch">
                            <i class="fas fa-chart-line"></i> TCH
                        </div>
                        <div class="tool-item" draggable="true" data-type="measure" data-measure="brix">
                            <i class="fas fa-percentage"></i> Brix
                        </div>
                        <div class="tool-item" draggable="true" data-type="measure" data-measure="sacarosa">
                            <i class="fas fa-cube"></i> Sacarosa
                        </div>
                    </div>
                </div>

                <!-- Agregaciones -->
                <div class="tool-section">
                    <div class="tool-section-header collapsible" onclick="toggleSection(this)">
                        <span><i class="fas fa-calculator"></i> Agregaciones</span>
                    </div>
                    <div class="tool-section-content collapsible-content">
                        <div class="tool-item" draggable="true" data-type="aggregation" data-aggregation="sum">
                            <i class="fas fa-plus"></i> Suma
                        </div>
                        <div class="tool-item" draggable="true" data-type="aggregation" data-aggregation="avg">
                            <i class="fas fa-equals"></i> Promedio
                        </div>
                        <div class="tool-item" draggable="true" data-type="aggregation" data-aggregation="max">
                            <i class="fas fa-arrow-up"></i> Máximo
                        </div>
                        <div class="tool-item" draggable="true" data-type="aggregation" data-aggregation="min">
                            <i class="fas fa-arrow-down"></i> Mínimo
                        </div>
                        <div class="tool-item" draggable="true" data-type="aggregation" data-aggregation="count">
                            <i class="fas fa-hashtag"></i> Conteo
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel - Charts and Data -->
        <div class="panel data-panel">
            <div class="panel-header">
                <i class="fas fa-chart-line"></i> Análisis y Visualizaciones
            </div>
            <div class="panel-content">
                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h5><i class="fas fa-chart-bar"></i> Gráfico Principal</h5>
                        <canvas id="main-chart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- Data Table Section -->
                <div class="data-table-container">
                    <div class="data-table-header">
                        <h5><i class="fas fa-table"></i> Datos de la Operación</h5>
                        <div class="stats-mini">
                            <span id="total-records">0 registros</span>
                            <span id="execution-time">0.000s</span>
                        </div>
                    </div>
                    <div id="data-table-content">
                        <div class="empty-state">
                            <i class="fas fa-table"></i>
                            <p>Selecciona dimensiones y medidas para ver los datos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Dynamic Filters -->
        <div class="panel filters-panel">
            <div class="panel-header">
                <i class="fas fa-filter"></i> Filtros Dinámicos
            </div>
            <div class="panel-content">
                <!-- Dynamic Filters Container -->
                <div id="dynamic-filters">
                    <div class="empty-state">
                        <i class="fas fa-filter"></i>
                        <p>Selecciona dimensiones para habilitar filtros</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3">Procesando análisis...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let currentData = [];
    let currentCharts = [];
    let selectedDimensions = [];
    let selectedMeasures = [];
    let selectedAggregations = ['sum'];

    // Inicialización
    document.addEventListener('DOMContentLoaded', function() {
        initializeDragAndDrop();
        initializeEventListeners();
    });

    function initializeDragAndDrop() {
        // Configurar drag and drop
        document.querySelectorAll('.tool-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
        });

        // Configurar drop zones
        document.getElementById('dimensions-zone').addEventListener('dragover', handleDragOver);
        document.getElementById('dimensions-zone').addEventListener('drop', handleDrop);

        document.getElementById('measures-zone').addEventListener('dragover', handleDragOver);
        document.getElementById('measures-zone').addEventListener('drop', handleDrop);
    }

    function initializeEventListeners() {
        document.getElementById('execute-btn').addEventListener('click', executeAnalysis);
        document.getElementById('pivot-btn').addEventListener('click', createPivotTable);
        document.getElementById('export-btn').addEventListener('click', exportData);
    }

    function handleDragStart(e) {
        const data = {
            type: e.target.dataset.type,
            dimension: e.target.dataset.dimension,
            level: e.target.dataset.level,
            measure: e.target.dataset.measure,
            aggregation: e.target.dataset.aggregation
        };
        e.dataTransfer.setData('text/plain', JSON.stringify(data));
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        const targetZone = e.currentTarget;
        
        if (data.type === 'dimension' && targetZone.id === 'dimensions-zone') {
            addDimension(data);
        } else if (data.type === 'measure' && targetZone.id === 'measures-zone') {
            addMeasure(data);
        }
    }

    function addDimension(dimensionData) {
        if (!selectedDimensions.find(d => d.dimension === dimensionData.dimension && d.level === dimensionData.level)) {
            selectedDimensions.push(dimensionData);
            updateDimensionsZone();
        }
    }

    function addMeasure(measureData) {
        if (!selectedMeasures.find(m => m.measure === measureData.measure)) {
            selectedMeasures.push(measureData);
            updateMeasuresZone();
        }
    }

    function updateDimensionsZone() {
        const zone = document.getElementById('dimensions-zone');
        if (selectedDimensions.length === 0) {
            zone.innerHTML = '<span>Arrastra dimensiones aquí</span>';
            zone.className = 'drop-zone empty';
        } else {
            zone.className = 'drop-zone has-items';
            zone.innerHTML = selectedDimensions.map(dim => 
                `<div class="dropped-item">
                    ${getDimensionLabel(dim.dimension)} (${getLevelLabel(dim.level)})
                    <button class="remove-btn" onclick="removeDimension('${dim.dimension}', '${dim.level}')">×</button>
                </div>`
            ).join('');
        }
        updateStats();
        updateDynamicFilters();
    }

    function updateMeasuresZone() {
        const zone = document.getElementById('measures-zone');
        if (selectedMeasures.length === 0) {
            zone.innerHTML = '<span>Arrastra medidas aquí</span>';
            zone.className = 'drop-zone empty';
        } else {
            zone.className = 'drop-zone has-items';
            zone.innerHTML = selectedMeasures.map(meas => 
                `<div class="dropped-item">
                    ${getMeasureLabel(meas.measure)}
                    <button class="remove-btn" onclick="removeMeasure('${meas.measure}')">×</button>
                </div>`
            ).join('');
        }
        updateStats();
    }

    function removeDimension(dimension, level) {
        selectedDimensions = selectedDimensions.filter(d => !(d.dimension === dimension && d.level === level));
        updateDimensionsZone();
    }

    function removeMeasure(measure) {
        selectedMeasures = selectedMeasures.filter(m => m.measure !== measure);
        updateMeasuresZone();
    }

    function updateStats() {
        document.getElementById('dimensions-count').textContent = selectedDimensions.length;
        document.getElementById('measures-count').textContent = selectedMeasures.length;
    }

    function displayResults(data) {
        currentData = data.records;
        
        // Actualizar estadísticas
        document.getElementById('total-records').textContent = data.record_count + ' registros';
        document.getElementById('execution-time').textContent = data.execution_time.toFixed(3) + 's';

        // Actualizar tabla de datos
        updateDataTable(data.records);

        // Actualizar gráfico principal
        updateMainChart(data.records);
    }

    async function executeAnalysis() {
        if (selectedMeasures.length === 0) {
            alert('Selecciona al menos una medida');
            return;
        }

        showLoading(true);

        try {
            const query = {
                operation: 'aggregate',
                measures: selectedMeasures.map(m => m.measure),
                dimensions: selectedDimensions.map(d => d.dimension),
                dimension_levels: selectedDimensions.reduce((acc, d) => {
                    acc[d.dimension] = d.level;
                    return acc;
                }, {}),
                filters: getFilters(),
                aggregation_functions: selectedAggregations,
                limit: 1000
            };

            const response = await fetch('/api/olap/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(query)
            });

            const result = await response.json();

            if (result.success) {
                displayResults(result.data);
            } else {
                alert('Error: ' + result.error);
            }
        } catch (error) {
            alert('Error de conexión: ' + error.message);
        } finally {
            showLoading(false);
        }
    }

    function updateDynamicFilters() {
        const container = document.getElementById('dynamic-filters');
        
        if (selectedDimensions.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-filter"></i><p>Selecciona dimensiones para habilitar filtros</p></div>';
            return;
        }

        let html = '';
        
        selectedDimensions.forEach(dim => {
            const filterKey = getFilterKey(dim.dimension, dim.level);
            const filterLabel = getDimensionLabel(dim.dimension) + ' (' + getLevelLabel(dim.level) + ')';
            
            html += `
                <div class="dynamic-filter-section">
                    <div class="dynamic-filter-header">
                        <i class="fas fa-filter"></i> ${filterLabel}
                    </div>
                    <div class="dynamic-filter-content">
                        <button class="select-all-btn" onclick="selectAllFilters('${filterKey}')">
                            Seleccionar Todos
                        </button>
                        <div class="filter-options" id="filter-${filterKey}">
                            ${getFilterOptions(dim.dimension, dim.level)}
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function getFilterKey(dimension, level) {
        return `${dimension}_${level}`;
    }

    function getFilterOptions(dimension, level) {
        // Opciones predefinidas basadas en la dimensión y nivel
        if (dimension === 'tiempo' && level === 'year') {
            return [2023, 2024, 2025].map(year => 
                `<div class="filter-option">
                    <input type="checkbox" id="year_${year}" value="${year}" data-filter="año">
                    <label for="year_${year}">${year}</label>
                </div>`
            ).join('');
        } else if (dimension === 'tiempo' && level === 'month') {
            const months = [
                {value: 1, name: 'Enero'}, {value: 2, name: 'Febrero'}, {value: 3, name: 'Marzo'},
                {value: 4, name: 'Abril'}, {value: 5, name: 'Mayo'}, {value: 6, name: 'Junio'},
                {value: 7, name: 'Julio'}, {value: 8, name: 'Agosto'}, {value: 9, name: 'Septiembre'},
                {value: 10, name: 'Octubre'}, {value: 11, name: 'Noviembre'}, {value: 12, name: 'Diciembre'}
            ];
            return months.map(month => 
                `<div class="filter-option">
                    <input type="checkbox" id="month_${month.value}" value="${month.value}" data-filter="mes">
                    <label for="month_${month.value}">${month.name}</label>
                </div>`
            ).join('');
        } else if (dimension === 'geografia' && level === 'zone') {
            const zones = ['Zona Norte', 'Zona Sur', 'Zona Este', 'Zona Oeste'];
            return zones.map(zone => 
                `<div class="filter-option">
                    <input type="checkbox" id="zone_${zone.replace(/\s+/g, '_')}" value="${zone}" data-filter="zona">
                    <label for="zone_${zone.replace(/\s+/g, '_')}">${zone}</label>
                </div>`
            ).join('');
        } else if (dimension === 'geografia' && level === 'farm') {
            // Para fincas, cargaremos dinámicamente desde la API
            return '<div class="filter-option"><span>Cargando fincas...</span></div>';
        } else if (dimension === 'producto' && level === 'variety') {
            // Para variedades, cargaremos dinámicamente desde la API
            return '<div class="filter-option"><span>Cargando variedades...</span></div>';
        }
        
        return '<div class="filter-option"><span>No hay opciones disponibles</span></div>';
    }

    function selectAllFilters(filterKey) {
        const checkboxes = document.querySelectorAll(`#filter-${filterKey} input[type="checkbox"]`);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
        });
    }

    function getFilters() {
        const filters = {};
        
        // Obtener filtros de checkboxes dinámicos
        document.querySelectorAll('#dynamic-filters input[type="checkbox"]:checked').forEach(checkbox => {
            const filterType = checkbox.dataset.filter;
            const value = checkbox.value;
            
            if (filterType === 'año') {
                filters.año = parseInt(value);
            } else if (filterType === 'mes') {
                filters.mes = parseInt(value);
            } else if (filterType === 'zona') {
                filters.zona = value;
            } else if (filterType === 'finca') {
                filters.finca = value;
            } else if (filterType === 'variedad') {
                filters.variedad = value;
            }
        });

        return filters;
    }

    function displayResults(data) {
        currentData = data.records;
        
        // Actualizar estadísticas
        document.getElementById('total-records').textContent = data.record_count;
        document.getElementById('execution-time').textContent = data.execution_time.toFixed(3) + 's';

        // Actualizar tabla de datos
        updateDataTable(data.records);

        // Actualizar gráficos
        updateCharts(data.records);
    }

    function updateDataTable(records) {
        const container = document.getElementById('data-table-content');
        
        if (records.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-table"></i><p>No se encontraron datos</p></div>';
            return;
        }

        const columns = Object.keys(records[0]);
        let html = '<table class="data-table"><thead><tr>';
        
        columns.forEach(col => {
            html += `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        records.forEach(record => {
            html += '<tr>';
            columns.forEach(col => {
                html += `<td>${record[col] || ''}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function updateMainChart(records) {
        // Destruir gráfico existente
        if (currentCharts.length > 0) {
            currentCharts[0].destroy();
            currentCharts = [];
        }

        if (records.length === 0) return;

        // Crear gráfico principal
        const ctx = document.getElementById('main-chart').getContext('2d');
        const chart = createMainChart(ctx, records);
        currentCharts.push(chart);
    }

    function createMainChart(ctx, records) {
        const columns = Object.keys(records[0]);
        const dimensionCols = columns.filter(col => 
            col.includes('_year') || col.includes('_month') || col.includes('_zone') || 
            col.includes('_farm') || col.includes('_variety')
        );
        const measureCols = columns.filter(col => 
            col.includes('_sum') || col.includes('_avg') || col.includes('_max') || col.includes('_min')
        );

        const labels = records.map(record => {
            if (dimensionCols.length > 0) {
                return record[dimensionCols[0]] || 'N/A';
            }
            return 'Registro ' + (records.indexOf(record) + 1);
        });

        const datasets = measureCols.slice(0, 2).map((col, index) => ({
            label: col.replace(/_/g, ' ').toUpperCase(),
            data: records.map(record => parseFloat(record[col]) || 0),
            backgroundColor: index === 0 ? '#2c5530' : '#4a7c59',
            borderColor: index === 0 ? '#2c5530' : '#4a7c59',
            borderWidth: 1
        }));

        return new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Análisis de Datos'
                    },
                    legend: {
                        display: datasets.length > 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createBarChart(ctx, records) {
        const columns = Object.keys(records[0]);
        const dimensionCols = columns.filter(col => 
            col.includes('_year') || col.includes('_month') || col.includes('_zone') || 
            col.includes('_farm') || col.includes('_variety')
        );
        const measureCols = columns.filter(col => 
            col.includes('_sum') || col.includes('_avg') || col.includes('_max') || col.includes('_min')
        );

        const labels = records.map(record => {
            if (dimensionCols.length > 0) {
                return record[dimensionCols[0]] || 'N/A';
            }
            return 'Registro ' + (records.indexOf(record) + 1);
        });

        const datasets = measureCols.slice(0, 2).map((col, index) => ({
            label: col.replace(/_/g, ' ').toUpperCase(),
            data: records.map(record => parseFloat(record[col]) || 0),
            backgroundColor: index === 0 ? '#2c5530' : '#4a7c59',
            borderColor: index === 0 ? '#2c5530' : '#4a7c59',
            borderWidth: 1
        }));

        return new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createLineChart(ctx, records) {
        const columns = Object.keys(records[0]);
        const dimensionCols = columns.filter(col => 
            col.includes('_year') || col.includes('_month') || col.includes('_zone') || 
            col.includes('_farm') || col.includes('_variety')
        );
        const measureCols = columns.filter(col => 
            col.includes('_sum') || col.includes('_avg') || col.includes('_max') || col.includes('_min')
        );

        const labels = records.map(record => {
            if (dimensionCols.length > 0) {
                return record[dimensionCols[0]] || 'N/A';
            }
            return 'Registro ' + (records.indexOf(record) + 1);
        });

        const datasets = measureCols.slice(0, 1).map((col, index) => ({
            label: col.replace(/_/g, ' ').toUpperCase(),
            data: records.map(record => parseFloat(record[col]) || 0),
            borderColor: '#6fa8dc',
            backgroundColor: 'rgba(111, 168, 220, 0.1)',
            fill: true,
            tension: 0.1
        }));

        return new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createPivotTable() {
        if (currentData.length === 0) {
            alert('Ejecuta primero un análisis para crear la tabla dinámica');
            return;
        }

        if (selectedDimensions.length < 2) {
            alert('Se necesitan al menos 2 dimensiones para crear una tabla dinámica');
            return;
        }

        // Implementar lógica de tabla dinámica
        alert('Función de tabla dinámica en desarrollo');
    }

    function exportData() {
        if (currentData.length === 0) {
            alert('No hay datos para exportar');
            return;
        }

        const csv = convertToCSV(currentData);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'analisis_datos.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function convertToCSV(data) {
        if (data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvHeaders = headers.join(',');
        const csvRows = data.map(row => 
            headers.map(header => `"${row[header] || ''}"`).join(',')
        );
        
        return [csvHeaders, ...csvRows].join('\n');
    }

    function showLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
    }

    function toggleSection(header) {
        const content = header.nextElementSibling;
        header.classList.toggle('collapsed');
        content.classList.toggle('collapsed');
    }

    // Funciones auxiliares
    function getDimensionLabel(dimension) {
        const labels = {
            'tiempo': 'Tiempo',
            'geografia': 'Geografía',
            'producto': 'Producto'
        };
        return labels[dimension] || dimension;
    }

    function getLevelLabel(level) {
        const labels = {
            'year': 'Año',
            'month': 'Mes',
            'zone': 'Zona',
            'farm': 'Finca',
            'variety': 'Variedad'
        };
        return labels[level] || level;
    }

    function getMeasureLabel(measure) {
        const labels = {
            'toneladas': 'Toneladas',
            'tch': 'TCH',
            'brix': 'Brix',
            'sacarosa': 'Sacarosa'
        };
        return labels[measure] || measure;
    }
</script>
{% endblock %}
