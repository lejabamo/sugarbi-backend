{% extends "base.html" %}

{% block title %}Chatbot - SugarBI{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-robot"></i> Chatbot SugarBI</h1>
        <p class="text-muted">Haz preguntas sobre los datos de cosecha en lenguaje natural</p>
    </div>
</div>

<div class="row">
    <!-- Chat Interface -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Conversación</h5>
            </div>
            <div class="card-body p-0">
                <div id="chat-container" class="chat-container p-3">
                    <div class="message bot-message">
                        <strong><i class="fas fa-robot"></i> SugarBI:</strong>
                        ¡Hola! Soy tu asistente de análisis de datos de cosecha. 
                        Puedes preguntarme cosas como:
                        <ul class="mb-0 mt-2">
                            <li>"Muéstrame el top 10 de fincas por producción"</li>
                            <li>"¿Cuáles son las mejores variedades por TCH?"</li>
                            <li>"Muéstrame la producción por zona en 2025"</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" id="query-input" class="form-control" 
                               placeholder="Escribe tu consulta aquí..." 
                               onkeypress="handleKeyPress(event)">
                        <button class="btn btn-primary" onclick="sendQuery()">
                            <i class="fas fa-paper-plane"></i> Enviar
                        </button>
                    </div>
                    <div id="loading" class="loading text-center mt-2">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <span class="ms-2">Procesando consulta...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Query Analysis -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-search"></i> Análisis de Consulta</h5>
            </div>
            <div class="card-body">
                <div id="query-analysis">
                    <p class="text-muted">Haz una consulta para ver el análisis aquí</p>
                </div>
            </div>
        </div>

        <!-- SQL Query -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Consulta SQL</h5>
            </div>
            <div class="card-body">
                <div id="sql-query">
                    <p class="text-muted">La consulta SQL aparecerá aquí</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Visualization Area -->
<div class="row mt-4" id="visualization-area" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Visualización</h5>
            </div>
            <div class="card-body">
                <div id="chart-container" class="chart-container">
                    <canvas id="result-chart"></canvas>
                </div>
                
                <!-- Data Table -->
                <div id="data-table" class="mt-3">
                    <h6>Datos</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="results-table">
                            <thead id="table-head"></thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentChart = null;

// Manejar Enter en el input
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendQuery();
    }
}

// Enviar consulta
async function sendQuery() {
    const queryInput = document.getElementById('query-input');
    const query = queryInput.value.trim();
    
    if (!query) {
        showError('Por favor, escribe una consulta');
        return;
    }
    
    // Agregar mensaje del usuario al chat
    addMessageToChat(query, 'user');
    
    // Limpiar input
    queryInput.value = '';
    
    // Mostrar loading
    showLoading('loading');
    
    try {
        // Enviar consulta al servidor
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: query })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Mostrar respuesta del bot
            addMessageToChat('Consulta procesada exitosamente. Aquí están los resultados:', 'bot');
            
            // Mostrar análisis de la consulta
            showQueryAnalysis(result.data.intent);
            
            // Mostrar SQL generado
            showSQLQuery(result.data.sql);
            
            // Mostrar visualización
            showVisualization(result.data.visualization, result.data.raw_data);
            
        } else {
            const errorMessage = result.error || 'Error desconocido';
            addMessageToChat(`Error: ${errorMessage}`, 'bot');
            showError(errorMessage);
        }
        
    } catch (error) {
        addMessageToChat(`Error de conexión: ${error.message}`, 'bot');
        showError('Error de conexión con el servidor');
    } finally {
        hideLoading('loading');
    }
}

// Agregar mensaje al chat
function addMessageToChat(message, sender) {
    const chatContainer = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const icon = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
    const name = sender === 'user' ? 'Tú' : 'SugarBI';
    
    messageDiv.innerHTML = `<strong><i class="${icon}"></i> ${name}:</strong> ${message}`;
    chatContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Mostrar análisis de la consulta
function showQueryAnalysis(intent) {
    const analysisDiv = document.getElementById('query-analysis');
    analysisDiv.innerHTML = `
        <div class="mb-2">
            <strong>Tipo:</strong> ${intent.type.replace('_', ' ')}
        </div>
        <div class="mb-2">
            <strong>Métrica:</strong> ${intent.metric.replace('_', ' ')}
        </div>
        <div class="mb-2">
            <strong>Dimensión:</strong> ${intent.dimension.replace('_', ' ')}
        </div>
        ${intent.filters && Object.keys(intent.filters).length > 0 ? `
        <div class="mb-2">
            <strong>Filtros:</strong>
            <ul class="mb-0">
                ${Object.entries(intent.filters).map(([key, value]) => 
                    `<li>${key}: ${value}</li>`
                ).join('')}
            </ul>
        </div>
        ` : ''}
        ${intent.limit ? `
        <div class="mb-2">
            <strong>Límite:</strong> ${intent.limit}
        </div>
        ` : ''}
    `;
}

// Mostrar consulta SQL
function showSQLQuery(sql) {
    const sqlDiv = document.getElementById('sql-query');
    sqlDiv.innerHTML = `
        <pre class="bg-light p-2 rounded"><code>${sql}</code></pre>
    `;
}

// Mostrar visualización
function showVisualization(vizConfig, rawData) {
    const vizArea = document.getElementById('visualization-area');
    vizArea.style.display = 'block';
    
    // Destruir gráfico anterior si existe
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Crear nuevo gráfico
    const ctx = document.getElementById('result-chart').getContext('2d');
    currentChart = new Chart(ctx, vizConfig);
    
    // Mostrar tabla de datos
    showDataTable(rawData);
}

// Mostrar tabla de datos
function showDataTable(data) {
    if (!data || data.length === 0) return;
    
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    
    // Limpiar tabla
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';
    
    // Crear encabezados
    const headers = Object.keys(data[0]);
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header.replace('_', ' ').toUpperCase();
        headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);
    
    // Crear filas de datos
    data.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '-';
            tr.appendChild(td);
        });
        tableBody.appendChild(tr);
    });
}

// Cargar ejemplos de consultas
async function loadExampleQueries() {
    try {
        const response = await fetch('/api/examples');
        const result = await response.json();
        
        if (result.success) {
            const examplesDiv = document.getElementById('example-queries');
            examplesDiv.innerHTML = '';
            
            result.data.examples.forEach(example => {
                const div = document.createElement('div');
                div.className = 'example-query';
                div.textContent = example;
                div.onclick = () => useExampleQuery(div);
                examplesDiv.appendChild(div);
            });
        }
    } catch (error) {
        console.error('Error loading examples:', error);
    }
}

// Cargar ejemplos al cargar la página
document.addEventListener('DOMContentLoaded', loadExampleQueries);
</script>
{% endblock %}






